# 🎮 API Integration - Aviator Game

## ✅ Реализовано

### 1. Логика работы со ставками

#### 📍 Начало игры (Ставка)
**Файл:** `res/js/game.js` → функция `loading_to_flying()`

```javascript
// ВЫЧИТАЕМ СТАВКИ ИЗ БАЛАНСА СРАЗУ ПРИ НАЧАЛЕ ИГРЫ
$('.make_bet').each(function(){
    if( $id ){
        var $bet = parseFloat( $('input[type="text"]', $wrap).val() );
        // ВЫЧИТАЕМ СТАВКУ ИЗ БАЛАНСА
        $user.balance -= $bet;
        $user.balance = Math.round($user.balance * 100) / 100;
    }
});
```

**Что происходит:**
- ✅ Ставка вычитается СРАЗУ при начале игры
- ✅ Баланс обновляется локально
- ✅ Баланс округляется до 2 знаков после запятой

---

#### 📍 Выигрыш (WIN)
**Файл:** `res/js/game.js` → функция `bet_complete()`

```javascript
// ДОБАВЛЯЕМ ВЫИГРЫШ К БАЛАНСУ
var winAmount = betAmount * coefficient;
$user.balance += winAmount;
$user.balance = Math.round($user.balance * 100) / 100;

// Отправляем результат в API
if (window.$aviatorAPI && window.$aviatorAPI.hasToken()) {
    window.$aviatorAPI.sendGameResult('win', betAmount, winAmount, $user.balance);
}
```

**Что происходит:**
- ✅ Рассчитывается выигрыш: `ставка × коэффициент`
- ✅ Выигрыш ДОБАВЛЯЕТСЯ к текущему балансу
- ✅ Баланс округляется до 2 знаков
- ✅ Результат отправляется в API

---

#### 📍 Проигрыш (LOSE)
**Файл:** `res/js/game.js` → функция `flying_to_finish()`

```javascript
// ОБРАБАТЫВАЕМ ПРОИГРЫШИ
$('.make_bet').each(function(){ 
    if( $id ){
        // Эта ставка не была выведена = ПРОИГРЫШ
        // Баланс НЕ меняется (ставка уже была вычтена в начале игры)
        $user.balance = Math.round($user.balance * 100) / 100;
    }
});

// Отправляем результат проигрыша в API
if (hasLostBets && window.$aviatorAPI && window.$aviatorAPI.hasToken()) {
    window.$aviatorAPI.sendGameResult('loss', totalLostAmount, 0, $user.balance);
}
```

**Что происходит:**
- ✅ Баланс НЕ изменяется (ставка уже была вычтена)
- ✅ Баланс округляется до 2 знаков
- ✅ Результат отправляется в API

---

### 2. API Интеграция

**Файл:** `res/js/api.js`

#### API Endpoints

##### 1️⃣ Обновление баланса (WIN/LOSS)
```
PUT https://api.valor-games.co/api/user/deposit/
```

**Запрос:**
```json
{
  "deposit": 1234.56
}
```

**Ответ (вариант 1):**
```json
{
  "balance": 1234.56,
  "success": true
}
```

**Ответ (вариант 2):**
```json
{
  "old_deposit": 1000.00,
  "new_deposit": 1234.56,
  "success": true
}
```

---

##### 2️⃣ Получение информации о пользователе
```
GET https://api.valor-games.co/api/user/info/
```

**Запрос:**
```
Authorization: Bearer {access_token}
```

**Ответ:**
```json
{
  "user_id": 123456,
  "deposit": 1234.56,
  "country": "Colombia",
  "country_info": {
    "currency": "COP",
    "name": "Colombia"
  },
  "success": true
}
```

---

### 3. Схема работы

```
┌─────────────────────────────────────────────────────────────────┐
│                    НАЧАЛО ИГРЫ (Ставка)                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Баланс: 1000 USD │
                    │ Ставка: 10 USD   │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ balance -= bet   │
                    │ 1000 - 10 = 990  │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Игра начинается  │
                    │ Баланс: 990 USD  │
                    └──────────────────┘
                              │
                ┌─────────────┴─────────────┐
                ▼                           ▼
      ┌──────────────┐            ┌──────────────┐
      │   ВЫИГРЫШ    │            │   ПРОИГРЫШ   │
      └──────────────┘            └──────────────┘
                │                           │
                ▼                           ▼
    ┌────────────────────┐      ┌────────────────────┐
    │ Коэффициент: 2.5x  │      │ Баланс остается:   │
    │ Выигрыш: 10×2.5=25 │      │ 990 USD            │
    │ balance += 25      │      │ (ставка уже вычтена)│
    │ 990 + 25 = 1015    │      └────────────────────┘
    └────────────────────┘                │
                │                           │
                ▼                           ▼
    ┌────────────────────┐      ┌────────────────────┐
    │ Итоговый баланс:   │      │ Итоговый баланс:   │
    │ 1015 USD           │      │ 990 USD            │
    └────────────────────┘      └────────────────────┘
                │                           │
                └─────────────┬─────────────┘
                              ▼
                  ┌──────────────────────┐
                  │  API: PUT /deposit/  │
                  │  { deposit: 1015 }   │
                  │  или                 │
                  │  { deposit: 990 }    │
                  └──────────────────────┘
                              │
                              ▼
                  ┌──────────────────────┐
                  │  API Response:       │
                  │  { balance: 1015 }   │
                  │  или                 │
                  │  { new_deposit: 990 }│
                  └──────────────────────┘
                              │
                              ▼
                  ┌──────────────────────┐
                  │ Баланс обновлен в БД │
                  │ Игра завершена       │
                  └──────────────────────┘
```

---

## 🔑 Ключевые моменты

### ✅ Логика баланса:
1. **Ставка вычитается СРАЗУ** при начале игры (`loading_to_flying`)
2. **При выигрыше** - добавляется выигрыш (ставка × коэффициент)
3. **При проигрыше** - баланс не меняется (ставка уже вычтена)
4. **API получает** итоговый баланс после всех операций

### ✅ Безопасность:
- Все API запросы требуют `Authorization: Bearer {token}`
- Токен передается через URL параметр `?access_token=...`
- Токен сохраняется в `window.ACCESS_TOKEN`

### ✅ Синхронизация:
- После каждой игры вызывается `fetchUserInfo()` для синхронизации
- Баланс из API имеет приоритет над локальным
- Исключение: если игра активна и локальный баланс больше

### ✅ Демо режим:
- В демо режиме API запросы **НЕ отправляются**
- Баланс хранится только локально в браузере
- Проверка: `if (!window.ACCESS_TOKEN)` → пропускаем API

---

## 🧪 Примеры

### Пример 1: Выигрыш
```
Начальный баланс: 1000 USD
Ставка: 10 USD
Коэффициент: 2.5x

1. Начало игры:
   balance = 1000 - 10 = 990 USD

2. Выигрыш:
   award = 10 × 2.5 = 25 USD
   balance = 990 + 25 = 1015 USD

3. API запрос:
   PUT /api/user/deposit/
   { "deposit": 1015.00 }

4. API ответ:
   { "balance": 1015.00 }
```

### Пример 2: Проигрыш
```
Начальный баланс: 1000 USD
Ставка: 10 USD

1. Начало игры:
   balance = 1000 - 10 = 990 USD

2. Проигрыш:
   balance = 990 USD (не меняется)

3. API запрос:
   PUT /api/user/deposit/
   { "deposit": 990.00 }

4. API ответ:
   { "balance": 990.00 }
```

---

## 📁 Измененные файлы

1. **res/js/api.js** - Новый файл с API интеграцией
2. **res/js/game.js** - Обновлена логика ставок и выигрышей:
   - `bet_add()` - НЕ вычитает ставку
   - `loading_to_flying()` - Вычитает ставки при начале игры
   - `bet_complete()` - Добавляет выигрыш и отправляет в API
   - `flying_to_finish()` - Обрабатывает проигрыши и отправляет в API
3. **templates/main.tpl.php** - Уже подключен api.js

---

## ✅ Готово к использованию!

Система полностью реализована и готова к работе с API valor-games.co.
